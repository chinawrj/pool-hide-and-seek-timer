name: Build and Release APK

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build Release APK
      run: ./gradlew assembleRelease
      
    - name: Sign APK (Debug keystore for demo)
      run: |
        # ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨debug keystoreç­¾å
        # åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½ åº”è¯¥ä½¿ç”¨è‡ªå·±çš„ç­¾åå¯†é’¥
        $ANDROID_HOME/build-tools/*/apksigner sign \
          --ks ~/.android/debug.keystore \
          --ks-key-alias androiddebugkey \
          --ks-pass pass:android \
          --key-pass pass:android \
          --out app/build/outputs/apk/release/app-release-signed.apk \
          app/build/outputs/apk/release/app-release-unsigned.apk
      continue-on-error: true  # å¦‚æœç­¾åå¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨æœªç­¾åç‰ˆæœ¬
      
    - name: Rename APK
      run: |
        # è·å–ç‰ˆæœ¬æ ‡ç­¾
        VERSION=${GITHUB_REF#refs/tags/}
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨å·²ç­¾åçš„APK
        if [ -f "app/build/outputs/apk/release/app-release-signed.apk" ]; then
          cp app/build/outputs/apk/release/app-release-signed.apk pool-hide-and-seek-timer-${VERSION}.apk
        else
          cp app/build/outputs/apk/release/app-release-unsigned.apk pool-hide-and-seek-timer-${VERSION}.apk
        fi
        
    - name: Get APK info
      run: |
        APK_FILE=$(ls pool-hide-and-seek-timer-*.apk)
        APK_SIZE=$(ls -lh $APK_FILE | awk '{print $5}')
        echo "APK_FILE=$APK_FILE" >> $GITHUB_ENV
        echo "APK_SIZE=$APK_SIZE" >> $GITHUB_ENV
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: ${{ github.ref }} - æ³³æ± æ‰è¿·è—è®¡æ—¶å™¨
        body: |
          # ğŸŠâ€â™‚ï¸ æ³³æ± æ‰è¿·è—è®¡æ—¶å™¨ ${{ github.ref }}
          
          ## ğŸ“± å…³äºåº”ç”¨
          ä¸“ä¸ºæ³³æ± æ‰è¿·è—æ¸¸æˆè®¾è®¡çš„è®¡æ—¶å™¨åº”ç”¨ã€‚å‚ä¸è€…æˆ´ä¸Šçœ¼é•œåæ— æ³•çœ‹åˆ°å‘¨å›´ç¯å¢ƒï¼Œåªèƒ½åœ¨æç¤ºéŸ³å“èµ·æœŸé—´çŸ­æš‚å–ä¸‹çœ¼é•œè§‚å¯Ÿç¯å¢ƒã€‚
          
          ## âœ¨ åŠŸèƒ½ç‰¹æ€§
          - â±ï¸ **å¯é…ç½®è®¡æ—¶é—´éš”**: 5-300ç§’ï¼ˆé»˜è®¤60ç§’ï¼‰
          - ğŸ”Š **å¯é…ç½®æç¤ºéŸ³æŒç»­æ—¶é—´**: 1-60ç§’ï¼ˆé»˜è®¤10ç§’ï¼‰
          - ğŸµ **ç³»ç»Ÿé“ƒå£°é€‰æ‹©**: å¯ä»è®¾å¤‡ä¸­é€‰æ‹©å–œæ¬¢çš„æç¤ºéŸ³å¹¶é¢„è§ˆ
          - ğŸ“± **ç°ä»£åŒ–ç•Œé¢**: Material Designè®¾è®¡ï¼Œç›´è§‚æ˜“ç”¨
          - ğŸŒ **åŒè¯­æ”¯æŒ**: å®Œæ•´çš„ä¸­è‹±æ–‡ç•Œé¢
          - ğŸ’¾ **æ™ºèƒ½ä¿å­˜**: è®¾ç½®è‡ªåŠ¨ä¿å­˜ï¼Œé‡å¯åº”ç”¨åä¿æŒé…ç½®
          - â¸ï¸ **å®Œæ•´æ§åˆ¶**: å¼€å§‹/åœæ­¢/é‡ç½®åŠŸèƒ½
          
          ## ğŸ® æ¸¸æˆè§„åˆ™
          1. å‚ä¸è€…æˆ´ä¸Šä¸é€æ˜çœ¼é•œï¼Œæ— æ³•çœ‹åˆ°å‘¨å›´ç¯å¢ƒ
          2. è®¡æ—¶å™¨æŒ‰è®¾å®šé—´éš”æ’­æ”¾æç¤ºéŸ³
          3. æç¤ºéŸ³å“èµ·æœŸé—´ï¼Œå‚ä¸è€…å¯ä»¥å–ä¸‹çœ¼é•œè§‚å¯Ÿç¯å¢ƒ
          4. æ‰¾åˆ°å¹¶è§¦ç¢°åˆ°æ³³æ± ä¸­çš„å…¶ä»–äººå³è·èƒœ
          
          ## ğŸ“¥ å®‰è£…è¯´æ˜
          1. ä¸‹è½½ä¸‹æ–¹çš„APKæ–‡ä»¶ï¼ˆå¤§å°: ${{ env.APK_SIZE }}ï¼‰
          2. åœ¨Androidè®¾å¤‡ä¸Šå¯ç”¨"å…è®¸å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨"
          3. å®‰è£…å¹¶è¿è¡Œåº”ç”¨
          
          ## ğŸ”§ ç³»ç»Ÿè¦æ±‚
          - Android 5.0 (API 21) æˆ–æ›´é«˜ç‰ˆæœ¬
          - æ”¯æŒæ‰€æœ‰Androidè®¾å¤‡
          
          ---
          
          # ğŸŠâ€â™‚ï¸ Pool Hide and Seek Timer ${{ github.ref }}
          
          ## ğŸ“± About
          A timer app specifically designed for pool hide-and-seek games. Players wear opaque goggles and can only briefly remove them to observe their surroundings when the alert sounds.
          
          ## âœ¨ Features
          - â±ï¸ **Configurable Timer Intervals**: 5-300 seconds (default 60s)
          - ğŸ”Š **Configurable Alert Duration**: 1-60 seconds (default 10s)  
          - ğŸµ **System Ringtone Selection**: Choose and preview your favorite alert sound
          - ğŸ“± **Modern Interface**: Material Design with intuitive controls
          - ğŸŒ **Bilingual Support**: Complete Chinese and English interface
          - ğŸ’¾ **Smart Saving**: Settings automatically saved across app restarts
          - â¸ï¸ **Full Control**: Start/Stop/Reset functionality
          
          ## ğŸ® Game Rules
          1. Players wear opaque goggles, unable to see surroundings
          2. Timer plays alert sound at set intervals
          3. During alert sound, players can remove goggles to observe
          4. Win by finding and touching another person in the pool
          
          ## ğŸ“¥ Installation
          1. Download the APK file below (Size: ${{ env.APK_SIZE }})
          2. Enable "Install from unknown sources" on your Android device
          3. Install and run the app
          
          ## ğŸ”§ Requirements
          - Android 5.0 (API 21) or higher
          - Compatible with all Android devices
          
          ---
          
          **âš¡ Built automatically by GitHub Actions**
        draft: false
        prerelease: false
        
    - name: Upload APK to Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ env.APK_FILE }}
        asset_name: ${{ env.APK_FILE }}
        asset_content_type: application/vnd.android.package-archive
